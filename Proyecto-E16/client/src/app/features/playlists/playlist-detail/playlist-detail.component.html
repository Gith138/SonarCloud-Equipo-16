<div class="playlist-detail-page">
  <div class="content-wrapper">

    <header class="header-section">
      <div>
        <h1 class="playlist-title">{{ playlist?.name_ || 'Playlist sin nombre' }}</h1>
        <p class="playlist-meta flex items-center gap-2">
          {{ playlist?.songs_?.length || 0 }} canciones â€¢ 
          <span [ngClass]="playlist?.isPublic_ ? 'text-green-400' : 'text-blue-400'" 
                class="font-bold uppercase text-xs tracking-widest border border-current px-2 py-0.5 rounded bg-opacity-10">
            {{ playlist?.isPublic_ ? 'PÃºblica' : 'Privada' }}
          </span>
        </p>
      </div>

      <div class="header-actions">
        <button (click)="showForm = !showForm" class="header-btn header-btn-primary">
          <span class="header-btn-icon">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
          </span>
          <span>{{ showForm ? 'Cancelar' : 'AÃ±adir canciÃ³n' }}</span>
        </button>


        <button *ngIf="isOwner" (click)="isSharing = !isSharing" class="header-btn header-btn-secondary">
          <span class="header-btn-icon">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l1.83-1.83a4 4 0 0 0-5.66-5.66L12 7"/><path d="M14 11a5 5 0 0 0-7.54-.54L4.63 12.3a4 4 0 0 0 5.66 5.66L12 17"/></svg>
          </span>
          <span>{{ isSharing ? 'Dejar de compartir' : 'Compartir' }}</span>
        </button>
      </div>
    </header>

    <div *ngIf="playlist" class="section-card">
      <h2 class="section-title">InformaciÃ³n de la Playlist</h2>

      <div class="flex items-center justify-between p-4 rounded-xl bg-[#0b0b12] border border-gray-800">
        <div class="user-info">
          <img 
            [src]="playlist.owner_?.displayAvatar || 'assets/perfil.png'" 
            class="avatar-small border-2"
            [ngClass]="playlist.isPublic_ ? 'border-green-500/40' : 'border-blue-500/40'"
            alt="Avatar"
          />
          <div class="flex flex-col">
            <span class="text-[10px] font-bold uppercase tracking-widest mb-1"
                  [ngClass]="playlist.isPublic_ ? 'text-green-400' : 'text-blue-400'">
              Creada por
            </span>
            <span class="text-lg font-medium text-white">
              {{ playlist.owner_?.username_ || 'Desconocido' }}
            </span>
          </div>
        </div>

        <button 
          *ngIf="isOwner && !playlist?.isPublic_" 
          (click)="showShareManager = true" 
          class="btn-gestion-acceso"
        >
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
            <circle cx="9" cy="7" r="4"></circle>
            <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
            <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
          </svg>
          Gestionar acceso
        </button>
      </div>
    </div>

    

    <!-- FORMULARIO COMPARTIR -->
    <div *ngIf="isSharing" class="song-search-section">
      <h2 class="form-title">Compartir playlist</h2>

      <div class="playlist-search-wrapper">
        
        <div class="search-wrapper wide relative">
          <span class="search-icon">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16"
                viewBox="0 0 24 24" fill="none" stroke="currentColor"
                stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="11" cy="11" r="8"></circle>
              <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
            </svg>
          </span>

          <input
            type="text"
            [(ngModel)]="shareTarget"
            (keyup.enter)="sharePlaylist()"
            (input)="searchUsersToShare()"
            class="search-input"
            placeholder="Ej. user o user@tempo.com"
            name="shareSearch"
          />
          <!-- Resultados bÃºsqueda usuarios -->
           <div *ngIf="filteredUsersForShare.length > 0" class="autocomplete-list">
            <div
              *ngFor="let user of filteredUsersForShare"
              (click)="selectUserForShare(user)"
              class="autocomplete-item"
            >
              <div class="flex items-center gap-3">
                <img [src]="user.displayAvatar || 'assets/default-avatar.png'" class="avatar-mini" />
                <div class="flex flex-col text-left">
                  <span class="font-semibold text-white text-sm">{{ user.username_ }}</span>
                  <span class="text-xs text-gray-400">{{ user.email_ }}</span>
                </div>
              </div>
              <span class="text-blue-400 text-xs sm:text-sm font-bold">Seleccionar</span>
            </div>
          </div>

        </div>

        <p class="search-help-text mt-2">
          Escribe el nombre o correo del usuario y pulsa Enter para compartir.
        </p>
      </div>
    </div>

    <!-- FORMULARIO AÃ‘ADIR CANCIÃ“N -->
    <section *ngIf="showForm" class="song-search-section">
      <h2 class="form-title">Buscar canciÃ³n para aÃ±adir</h2>

      <!-- Barra tipo Home -->
      <div class="playlist-search-wrapper">
        <div class="search-wrapper wide">
          <span class="search-icon">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="11" cy="11" r="8"></circle>
              <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
            </svg>
          </span>

          <input
            type="text"
            [(ngModel)]="searchQuery"
            (keyup.enter)="searchSongsForPlaylist()"
            placeholder="Buscar canciones en YouTube para aÃ±adir..."
            class="search-input"
            name="playlistSearch"
          />
        </div>

        <p class="search-help-text">
          Escribe el nombre de la canciÃ³n o artista y pulsa Enter para buscar.
        </p>
      </div>

      <!-- Resultados de bÃºsqueda -->
      <div *ngIf="searchResults.length > 0" class="search-results">
        <p class="search-results-title">Resultados</p>

        <div class="grid-songs">
          <div *ngFor="let video of searchResults" class="song-card compact">
            <img [src]="video.thumbnailURL_" class="song-img" />

            <div class="song-info">
              <div class="song-text">
                <h3 class="song-title">{{ video.title_ }}</h3>
                <p class="song-artist">{{ video.artist_ }}</p>
              </div>
            </div>

            <div class="song-actions icon-actions">
              <!-- BotÃ³n de reproducir igual que en la tabla de la playlist -->
              <button
                type="button"
                (click)="playSong(video.youtubeURL_, video.title_, video)"
                class="btn-icon btn-blue"
                title="Reproducir"
              >
                â–¶
              </button>

              <!-- BotÃ³n de aÃ±adir con icono tipo â€œlista +â€ -->
              <button
                type="button"
                (click)="addSearchResultToPlaylist(video)"
                class="btn-icon btn-add-icon"
                title="AÃ±adir a la playlist"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="16"
                  height="16"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <!-- Tres lÃ­neas tipo texto -->
                  <line x1="7" y1="9" x2="13" y2="9"></line>
                  <line x1="7" y1="12" x2="13" y2="12"></line>
                  <line x1="7" y1="15" x2="11" y2="15"></line>
                  <!-- SÃ­mbolo + a la derecha -->
                  <line x1="15.5" y1="10.5" x2="15.5" y2="13.5"></line>
                  <line x1="14" y1="12" x2="17" y2="12"></line>
                </svg>
              </button>
            </div>
          </div>
        </div>
      </div>

      <p *ngIf="!isSearching && !searchResults.length && searchQuery"
        class="text-sm text-gray-500 mt-4">
        No se encontraron resultados para "{{ searchQuery }}".
      </p>

      <p *ngIf="isSearching" class="text-sm text-gray-400 mt-4">
        Buscando canciones...
      </p>
    </section>

    <!-- CONTROLES DE ORDENACIÃ“N -->
    <div *ngIf="playlist?.songs_?.length" class="sort-bar">
      <span class="sort-label">Ordenar por</span>

      <button
        type="button"
        class="sort-pill"
        [ngClass]="{ 'sort-pill-active': songSortOrder === 'asc' }"
        (click)="songSortOrder = 'asc'"
      >
        TÃ­tulo Aâ€“Z
      </button>

      <button
        type="button"
        class="sort-pill"
        [ngClass]="{ 'sort-pill-active': songSortOrder === 'desc' }"
        (click)="songSortOrder = 'desc'"
      >
        TÃ­tulo Zâ€“A
      </button>
    </div>

    <!-- TABLA DE CANCIONES -->
    <div *ngIf="playlist?.songs_?.length; else noSongs" class="table-container">
      <table class="song-table">
        <thead>
          <tr class="table-head-row">
            <th class="py-3 px-4 w-12">#</th>
            <th class="py-3 px-4">TÃ­tulo</th>
            <th class="py-3 px-4 hidden sm:table-cell">Artista</th>
            <th class="py-3 px-4 text-center">AcciÃ³n</th>
          </tr>
        </thead>
        <tbody>
          <tr
            *ngFor="let song of sortedSongs; let i = index"
            class="table-body-row"
          >
            <td class="py-3 px-4 text-gray-500">{{ i + 1 }}</td>
            <td class="py-3 px-4 font-semibold text-white">{{ song.title_ }}</td>
            <td class="py-3 px-4 text-gray-400 hidden sm:table-cell">{{ song.artist_ }}</td>
            <td class="py-3 px-4 text-center">
              <div class="flex justify-center gap-2">
                <button
                  (click)="playSong(song.youtubeURL_, song.title_)"
                  class="btn-icon btn-blue"
                  title="Reproducir"
                >
                  â–¶
                </button>

                <button
                  (click)="deleteSong(song._id, song.title_)"
                  class="btn-icon btn-remove"
                  title="Eliminar"
                >
                  <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="3 6 5 6 21 6"></polyline>
                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                  </svg>
                </button>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- ESTADO SIN CANCIONES -->
    <ng-template #noSongs>
      <div class="empty-state">
        <p class="text-xl">ðŸŽµ Esta playlist aÃºn no tiene canciones.</p>
        <p class="text-sm text-gray-400 mt-2">Â¡AÃ±ade algunas usando el botÃ³n de arriba!</p>
      </div>
    </ng-template>

    <!-- REPRODUCTOR -->
    <div *ngIf="currentSongUrl" class="player-section">
      <p class="player-info">
        ðŸŽµ Reproduciendo: <span class="player-song-title">{{ currentSongTitle }}</span>
      </p>

      <audio
        [src]="currentSongUrl"
        controls
        autoplay
        class="audio-element"
        (error)="onAudioError()"
      >
        Tu navegador no soporta audio HTML5.
      </audio>
    </div>

  </div>

  

  <div class="modal-overlay" *ngIf="showShareManager" (click)="closeShareManager()">
    
    <div class="modal-content section-card animate-modal" (click)="$event.stopPropagation()">
      
      <div class="flex justify-between items-center mb-6 border-b border-gray-800 pb-4">
        <div>
          <h2 class="text-2xl font-bold text-white">GestiÃ³n de Acceso</h2>
          <p class="text-sm text-gray-500">Usuarios que pueden colaborar en esta playlist</p>
        </div>
        <button (click)="showShareManager = false" class="text-gray-400 hover:text-white transition-colors">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
        </button>
      </div>

      <div class="space-y-3 max-h-[50vh] overflow-y-auto pr-2 custom-scrollbar">
        <div *ngIf="playlist?.owner_group_?.length; else noSharedModal">
          
          <div *ngFor="let u of playlist.owner_group_" class="search-result-item animate-item">
            <div class="user-info">
              <img [src]="u.displayAvatar || 'assets/perfil.png'" class="avatar-small" alt="Avatar"/>
              <div class="flex flex-col">
                <span class="text-white font-medium text-lg">{{ u.username_ }}</span>
                <span class="text-xs text-gray-500">{{ u.email_ }}</span>
              </div>
            </div>

            <button (click)="unshare(u)" class="btn-quitar-colaborador">
              <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M3 6h18"></path>
                <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path>
                <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path>
              </svg>
              <span>Quitar</span>
            </button>
          </div>

        </div>

        <ng-template #noSharedModal>
          <div class="py-10 text-center rounded-xl bg-[#0b0b12]/50 border border-dashed border-gray-800">
            <p class="text-gray-500 italic">AÃºn no has compartido esta playlist con nadie.</p>
          </div>
        </ng-template>
      </div>
    </div>
  </div>

</div>
