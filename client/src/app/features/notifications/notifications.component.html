<div class="notification-widget" (clickOutside)="clickout($event)">
  
  <!-- BOTÓN CAMPANA -->
  <button class="bell-btn" (click)="toggleMenu()" [class.has-unread]="unreadCount > 0">
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="bell-icon">
      <path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"></path>
      <path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"></path>
    </svg>
    <span *ngIf="unreadCount > 0" class="badge-count">{{ unreadCount }}</span>
  </button>

  <!-- MENÚ DESPLEGABLE -->
  <div class="dropdown-menu" *ngIf="isOpen">
    <div class="dropdown-header">
      <h3>Notificaciones</h3>
      <small *ngIf="notifications.length > 0" (click)="clearAll($event)" class="clear-link">Borrar todo</small>
    </div>

    <div class="dropdown-content">
       <div *ngIf="notifications.length === 0" class="empty">
        No tienes notificaciones
       </div>

       <!-- ITEM NOTIFICACIÓN -->
       <div *ngFor="let notif of notifications" 
           class="notif-item" 
           [class.unread]="!notif.isRead_"
           (click)="onNotificationClick(notif)"> 
        
        <img [src]="notif.displayAvatar" class="avatar-mini" alt="Avatar">
        
        <div class="info">
          
          <!-- 1. TEXTO PRINCIPAL -->
          <p class="text">
            <strong>{{ notif.senderId_?.username_ || 'Sistema' }}</strong>
            
            <span *ngIf="notif.type_ === 'friend_request'"> quiere ser tu amigo.</span>
            <span *ngIf="notif.type_ === 'friend_accept'"> aceptó tu solicitud.</span>
            <span *ngIf="notif.type_ === 'system_alert'">: {{ notif.message_ }}</span>
            <span *ngIf="notif.type_ === 'song_recommendation'"> te recomienda:</span>
            <span *ngIf="notif.type_ === 'like_song'"> le gustó tu canción "{{ notif.data_?.title }}".</span>
            <span *ngIf="notif.type_ === 'message'"> te envió un mensaje.</span>
            
            <!--  CASO PLAYLIST: Muestra el nombre de la playlist -->
            <span *ngIf="notif.type_ === 'playlist_share'"> 
              te invitó a la playlist <em class="text-white not-italic font-semibold">{{ notif.data_?.playlistName }}</em>.
            </span>

            <span *ngIf="notif.type_ === 'playlist_unshare'"> 
              te eliminó de la playlist <em class="text-gray-400 not-italic">{{ notif.data_?.playlistName }}</em>.
            </span>
          </p>

          <!-- 2. CAJA DE LA CANCIÓN (Solo para recomendaciones) -->
          <div *ngIf="notif.type_ === 'song_recommendation'" 
               (click)="playSong($event, notif)" 
               class="mt-1 p-2 bg-black/20 rounded flex items-center gap-3 border border-gray-700/50 cursor-pointer hover:bg-black/40 transition-colors">
             
             <img 
               [src]="notif.data_?.thumbnail || 'assets/default-album.png'" 
               class="w-10 h-10 rounded object-cover shadow-sm flex-shrink-0"
             >
             
             <div class="overflow-hidden w-full">
               <p class="text-xs text-white font-bold whitespace-normal break-words leading-tight"
                  [innerHTML]="notif.data_?.title">
               </p>
             </div>
          </div>

          <!-- 3. MENSAJES ADICIONALES (Debajo de la caja o texto) -->
          
          <!-- Mensaje de recomendación de canción -->
          <p *ngIf="notif.type_ === 'song_recommendation' && notif.message_" 
             class="mt-1.5 text-xs text-gray-400 italic leading-snug">
             "{{ notif.message_ }}"
          </p>

          <!-- Mensaje de playlist (opcional, si el usuario escribió algo) -->
          <!-- Nota: En tu controlador actual el mensaje es automático, pero si en el futuro dejas escribir, saldrá aquí -->
          <p *ngIf="notif.type_ === 'playlist_share' && notif.message_ && !notif.message_.includes('te ha invitado')" 
             class="mt-1.5 text-xs text-gray-400 italic leading-snug">
             "{{ notif.message_ }}"
          </p>
          
          <span class="time">{{ notif.formattedDate }}</span>
        </div>
        
        <span class="indicator" *ngIf="!notif.isRead_">•</span>
      </div>

    </div>
  </div>
</div>